<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Auto-Directed L1 Video Stabilization - Refreshingly Dangerous</title>
<meta name="description" content="OMSCS 6475 Computational Photography - Fall 2020">


  <meta name="author" content="Marc Micatka">
  
  <meta property="article:author" content="Marc Micatka">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Refreshingly Dangerous">
<meta property="og:title" content="Auto-Directed L1 Video Stabilization">
<meta property="og:url" content="http://localhost:4000/stabilization/">


  <meta property="og:description" content="OMSCS 6475 Computational Photography - Fall 2020">



  <meta property="og:image" content="http://localhost:4000/assets/images/stabilization/thumbnail.png">





  <meta property="article:published_time" content="2021-03-24T00:00:00-07:00">



  <meta property="article:modified_time" content="2021-03-21T00:00:00-07:00">




<link rel="canonical" href="http://localhost:4000/stabilization/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Refreshingly Dangerous Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
<link rel="manifest" href="/assets/images/site.webmanifest">
<link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Refreshingly Dangerous
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/travel/">Travel</a>
            </li><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/photography/">Photography</a>
            </li><li class="masthead__menu-item">
              <a href="/posts/">All Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/headshot.jpeg" alt="Marc Micatka" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Marc Micatka</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Occasional computer scientist, mechanical engineer, and traveler.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Seattle, WA</span>
        </li>
      

      

      
        <li>
          <a href="marcmicatka.com" itemprop="url">
            <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span>
          </a>
        </li>
      

      
        <li>
          <a href="mailto:marc.micatka@gmail.com">
            <meta itemprop="email" content="marc.micatka@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/marcmicatka" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span>
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/marc-micatka" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Auto-Directed L1 Video Stabilization">
    <meta itemprop="description" content="OMSCS 6475 Computational Photography - Fall 2020">
    <meta itemprop="datePublished" content="2021-03-24T00:00:00-07:00">
    <meta itemprop="dateModified" content="2021-03-21T00:00:00-07:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Auto-Directed L1 Video Stabilization
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>The final for <em>CS 6475</em> focused on implementing a paper and trying to achieve similar results to the authors’ using our own images. We had a choice of five or six papers and I chose to try to implement <a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/37041.pdf" target="_blank"><em>Auto-Directed Video Stabilization with Robust L1 Optimal Camera Paths</em></a>. This paper is really awesome - there’s a ton of math and image processing techniques that get covered, and the results are actually really amazing. In fact, a modified version of this technique is still used in Google products.</p>

<p>Video stabilization is the process of…stabilizing a shaky video! There are two main way to achieve stabilization - physical or digital. <em>Physical</em> stabilization requires the use of gimbals, tripods, or other methods to eliminate the shake <em>as it happens</em>. Digital stabilization takes place sometime after the frame has been captured and is a post-processing step. We will be executing digitial video stabilization.</p>

<p>Let’s start with some results. We’ll be using an <a href="https://www.youtube.com/watch?v=2S_U1pnLE-M&amp;t=0s" target="_blank">example video</a> (not shot by me) that the paper uses. My results are shown side-by-side with the input video.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/yvPAclwMt7Q" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h3 id="video-stabilization-overview">Video Stabilization Overview</h3>
<p>Stabilization requires a few steps.</p>

<ol>
  <li><strong>Find the motion change (change in x, y, angle, and scale) between subsequent frames​</strong></li>
  <li><strong>Smooth the resulting motion model to remove jitters (post-processed)​</strong>
    <ul>
      <li>The motion model can be found using a feature matching algorithm to estimate an affine transformation matrix.</li>
      <li>Use L1 trend fitting as an algorithmic interpretation of how a camera would move if it were moved professionally/optimally.</li>
    </ul>
  </li>
  <li><strong>Transform original motion path to smooth motion path​</strong></li>
  <li><strong>Apply transformation to video</strong></li>
</ol>

<h3 id="l1-trend-fitting">L1 Trend Fitting</h3>
<p>L1 trend fitting seeks to approximate an input with a piecewise fit of different motion models. In our case, our input is the shake motion and the motion models are one of three difference motions:</p>

<ol>
  <li>Stationary
    <ul>
      <li>Analogous to using a tripod</li>
      <li>Constant Position, No Velocity</li>
      <li>dP/dT = 0</li>
    </ul>
  </li>
  <li>Constant Motion
    <ul>
      <li>Analogous to using a dolly/panning</li>
      <li>Constant Velocity, No Acceleration</li>
      <li>dP^2/dT = 0</li>
    </ul>
  </li>
  <li>Smooth Transitions
    <ul>
      <li>Analogous to changing between types 1 and 2 smoothly</li>
      <li>Constant Acceleration, No Jerk</li>
      <li>dP^3/dT = 0</li>
    </ul>
  </li>
</ol>

<figure class="third">
  <img src="http://localhost:4000//assets/images/stabilization/0_position.png" alt="" />
  <img src="http://localhost:4000//assets/images/stabilization/0_velocity.png" alt="" />
  <img src="http://localhost:4000//assets/images/stabilization/0_acceleration.png" alt="" />
<figcaption>An example of the motion models as seen in the optimal trend path.</figcaption>
</figure>

<h3 id="computational-pipeline">Computational Pipeline</h3>
<p>The implementation will follow this basic computational pipeline:</p>

<figure class="align-center">
  <img src="http://localhost:4000//assets/images/stabilization/pipeline.png" alt="" />
</figure>

<figure style="width: 350px" class="align-right">
  <img src="http://localhost:4000//assets/images/stabilization/load_video.png" alt="" />
</figure>

<h3 id="video-input">Video Input</h3>
<p>This one is pretty straightforward. We are loading all frames of the video into a buffer. This isn’t <em>strictly</em> necessary, and is actually a memory-bottleneck down the road for longer or more high-quality videos. But for prototyping a working stabilization system, this works well.</p>

<h3 id="calculating-motion">Calculating Motion</h3>
<p>To find the motion between subsequent frames, we have a few methods to choose from. The paper uses Lukas-Kanade optical flow. I experimented with a keypoint-based detector like ORB or SIFT and the results were very similiar.</p>

<ol>
  <li>Find matching points between frame i-1 (img1 in the code) and frame i (img2).</li>
  <li>Use these points to estimate the <em>affine transformation</em> between the two images.
    <ul>
      <li>This will be a 3x3 homography matrix</li>
    </ul>
  </li>
  <li>Throw out the last line of the homography as we’re only interested in the <em>affine</em> components</li>
</ol>

<p>Here’s how we can do that in Python with OpenCV:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">lk_tracking</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">maxCorners</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">qualityLevel</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">minDistance</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">blockSize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">image_1_points</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">st</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">image_2_points</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">st</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">estimateAffinePartial2D</span><span class="p">(</span><span class="n">image_1_points</span><span class="p">,</span> <span class="n">image_2_points</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transform</span>
</code></pre></div></div>
<p>We can plot the keypoints we’ve found to see how the same points are found in subsequent frames.</p>
<figure class="align-center">
  <img src="http://localhost:4000//assets/images/stabilization/keypoints.png" alt="" />
</figure>

<p>Once we’ve found the points, we estimate the transform.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">img_cnt</span><span class="p">):</span>
        <span class="n">It1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">It</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">find_homography</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">It1</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ft</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ft</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="bp">self</span><span class="p">.</span><span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">img_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ft</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">img_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ft</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<p>You can see how we’ve manually replaced the last row of the homography matrix <em>h</em> with [0, 0, 1]. This is because we are only considering affine transforms - translation, rotation, and scale. We are <strong>not</strong> considering shear or perspective skews. This is an assumption that helps us solve the resulting optimal paths problem in a reasonable amount of time (as we’ll see below). It is also a pretty <em>safe</em> assumption because the changes between frames of a video are reasonably small.
The other thing we’ve done is stored all of the <em>cummulative</em> matrices in <em>ct</em>. What we’re left with is the individual homography transforms from image i-1 to i in <em>ft</em> and the <em>total</em> motion from image 0 to image i in <em>ct</em>. This will be very important for our final smoothing.</p>

<h3 id="smooth-motion">Smooth Motion</h3>
<p>Here’s where the magic happens! We’ve found our homography matrix: \(h = \begin{bmatrix}
a &amp; b &amp; dx\\
c &amp; d &amp; dy\\
0 &amp; 0 &amp;1
\end{bmatrix}\)</p>

<p>We can use some matrix math and CV transforms to decompose this matrix into individual translation, rotation, and scale components:</p>

\[Translation: t_x = dy, t_y = dy\]

\[Rotation: \theta = tan^{-1}\frac{c}{a}\]

\[Scale: s = \sqrt{a^2 + c^2}\]

<p>We want to smooth these values using our L1 trend fitting process.
To do this, we use a linear programming package and find our motion derivatives. We are seeking to minimize the objective function \(O(P) = w_1 |D(P)| + w_2|D^2(P)| + w_3|D^3(P)|\) where \(D(P), D^2(P)\), and \(D^3(P)\) are the change in position, velocity, and acceleration. \(w_1, w_2\), and \(w_3\) are weights chosen by us to control how much of each type of motion appears in the final piecewise function.</p>

<p>To find these, we simply use the difference between subsequent data points. We can exploit the <em>sparcematrix</em> datatype in Numpy to help do this pretty quickly. We use the <em>_.variable</em> construct in our LP package <em>cvxpy</em> to contruct our minimization variables and define our objective function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">smooth_motion2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">img_cnt</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

    <span class="c1"># Form second difference matrix.
</span>    <span class="n">d1</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">d3</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">e</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    
    <span class="n">E</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
    <span class="n">e3</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>

    <span class="n">fnc</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">e2</span> <span class="o">+</span> <span class="n">w3</span> <span class="o">*</span> <span class="n">e3</span><span class="p">)</span>
</code></pre></div></div>

<p>We add some constraints to our minimiation problem to force the new path to stay inside the bounds of the old frame. We can only move the video so much in one direction before we find ourselves running out of frame. For this project, we’ve chosen to reduce the final image by 80% - giving us 20% of the frame size for wiggle room to do our stabilization. Once we’ve added the constraints, we can minimize our objective function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">fnc</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="p">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span>
<span class="n">prob</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">cp</span><span class="p">.</span><span class="n">ECOS</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<p>The smoothed motion output (in one direction only) looks something like this:</p>
<figure size="200px" class="align-center">
  <img src="http://localhost:4000//assets/images/stabilization/smooth_x.png" alt="" />
</figure>

<h3 id="applying-the-new-motion">Applying the New Motion</h3>
<p>Our our new, desired motion was found in the previous step. We now need to somehow <em>apply</em> that motion to the original video frame. The red line is where we <em>want</em> to be, the blue line is where we <em>are</em>. How do we find a transformation from one line to the other?</p>

<p>Matrix math comes to the rescue again! If <em>Ct</em> is our original path (blue line) and <em>Pt</em> is the desired path (red) - there is some transformation <em>Bt</em> that converts between them such that <em>Pt = Ct * Pt</em>. To solve for <em>Bt</em>, we can simply take the inverse of Ct dotted with <em>Pt</em>:</p>

\[B_t = C_t \cdot P_t^{-1}\]

<p>This is why is useful to define a cummulative motion model instead of a frame to frame transform. If we are trying to get stabilize Frame 3, we need to know what happened in Frames 1 <strong>and</strong> 2, not simply what happened between frames 2 and 3. Our accummulation of motion into <em>Ct</em> has kept track of this motion for us. If you look at the smoothed x plot in the previous section, you can see that the y-axis runs to -700 pixels. This clearly isn’t possible in a single frame. Instead, what we’re looking at is the total motion in x from the first frame and on.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new_frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">img_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span><span class="p">]).</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">warp_points</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">box</span><span class="p">:</span>
            <span class="n">tmp_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">draw_box</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_points</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">crop_to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_points</span><span class="p">)</span>

        <span class="n">new_frames</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_frame</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">new_frames</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_frames</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">warp_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bt</span><span class="p">):</span>
    <span class="n">new_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_high</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_high</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_high</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_high</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">new_pts</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">new_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">new_points</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">new_points</span>
</code></pre></div></div>

<h3 id="cropping-the-frame-and-video-output">Cropping the Frame and Video Output</h3>
<p>The last steps are cropping the frame and outputting video. 
Cropping the frame is pretty straightfoward - we can simply take the center of the new image reduced by 80% (see the section <strong>Smooth Motion</strong>). If we didn’t crop the edges, our result would look something like this:</p>

<figure size="200px" class="align-center">
  <img src="http://localhost:4000//assets/images/stabilization/uncropped.gif" alt="" />
</figure>

<p>Alternatively, we can keep the original frame and instead draw a box on the region that we <strong>would</strong> keep. This isn’t helpful for stabilization but it is interesting to look at.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">crop_to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">src_pts</span><span class="p">):</span>
    <span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">src_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_high</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_high</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_high</span><span class="p">],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">x_high</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">]]).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">)</span>
    <span class="n">new_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">h</span><span class="p">))</span>
    <span class="n">new_frame</span> <span class="o">=</span> <span class="n">new_frame</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">y_low</span><span class="p">:</span><span class="bp">self</span><span class="p">.</span><span class="n">y_high</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">x_low</span><span class="p">:</span><span class="bp">self</span><span class="p">.</span><span class="n">x_high</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">new_frame</span>

<span class="k">def</span> <span class="nf">draw_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">line</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>
</code></pre></div></div>

<p>Drawing the box looks like this:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/m11D27G2hK4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h3 id="conclusions">Conclusions</h3>
<p>This method as implemented has a lot of limitations:</p>

<ul>
  <li>Slow on large and high-resolution videos
    <ul>
      <li>The image can be loaded sequentially to avoid storing it memory</li>
      <li>Parallelize the computation for longer videos</li>
    </ul>
  </li>
  <li>Doesn’t stabilize based on the subject
    <ul>
      <li>If the subject strays to the outer 20% of the frame, they will get cropped out</li>
      <li>Perform object/face recognition on the subject and add those points as constraints to the minimization problem</li>
    </ul>
  </li>
  <li>Motion blur can be disorienting
    <ul>
      <li>When blur is in the direction of motion, we tend to ignore it. Stabilization can make motion blur occur in the wrong/unexpected direction</li>
    </ul>
  </li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#computer-vision" class="page__taxonomy-item" rel="tag">Computer Vision</a><span class="sep">, </span>
    
      <a href="/tags/#omscs" class="page__taxonomy-item" rel="tag">OMSCS</a><span class="sep">, </span>
    
      <a href="/tags/#projects" class="page__taxonomy-item" rel="tag">Projects</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-03-21">March 21, 2021</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/winds3/" class="pagination--pager" title="Wind River Range - 2020 (Part 1)
">Previous</a>
    
    
      <a href="/2020_travel/" class="pagination--pager" title="2020 - A Retrospective
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="https://farm66.staticflickr.com/65535/52306070656_b55f97890b.jpg" alt="">
      </div>
    
    
    <h2 class="archive__item-title" itemprop="headline">
    
      
        <a href="/ptarmigan/" rel="permalink">North Cascades - Ptarmigan Loop
</a>
      
        


    </h2>


      <p class="archive__item-excerpt" itemprop="description">High peaks and bushwacking.
</p>
      

    

    
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/rainier/thumbnail.jpg" alt="">
      </div>
    
    
    <h2 class="archive__item-title" itemprop="headline">
    
      
        <a href="/rainier/" rel="permalink">Skiing Camp Muir
</a>
      
        


    </h2>


      <p class="archive__item-excerpt" itemprop="description">Ross shreds, Marc…manages.
</p>
      

    

    
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2020/thumbnail.jpg" alt="">
      </div>
    
    
    <h2 class="archive__item-title" itemprop="headline">
    
      
        <a href="/2020_travel/" rel="permalink">2020 - A Retrospective
</a>
      
        


    </h2>


      <p class="archive__item-excerpt" itemprop="description">Life and adventures during a global pandemic
</p>
      

    

    
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/winds3/thumbnail.jpg" alt="">
      </div>
    
    
    <h2 class="archive__item-title" itemprop="headline">
    
      
        <a href="/winds3/" rel="permalink">Wind River Range - 2020 (Part 1)
</a>
      
        


    </h2>


      <p class="archive__item-excerpt" itemprop="description">Back for More. Again. Part 1.
</p>
      

    

    
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://linkedin.com/marcmicatka" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin-in" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/marc-micatka" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="marc.micatka@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
    

  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Refreshingly Dangerous. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
